{% extends "base.html" %}
{% block title %}Students{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_students.css') }}">
<div class="students-container">
    <!-- Header with Stats -->
    <div class="page-header">
        <div class="header-content">
            <div>
                <h1><i class="fas fa-users"></i> Student Management</h1>
                <p class="header-subtitle">Manage student information, fees, and ratings</p>
            </div>
            <div id="statsContainer" class="stats-container">
                <!-- Stats will be loaded dynamically -->
            </div>
        </div>
        <button class="export-btn" onclick="exportStudents()">
            <i class="fas fa-file-export"></i> Export CSV
        </button>
    </div>

    <!-- Filters Section -->
    <div class="filters-card">
        <div class="filters-header">
            <h3><i class="fas fa-filter"></i> Filters & Search</h3>
            <button class="btn-clear" onclick="clearFilters()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
        
        <div class="filters-grid">
            <div class="filter-group">
                <label><i class="fas fa-search"></i> Search</label>
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" placeholder="Search by name, email, or phone...">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-layer-group"></i> Batch</label>
                <select id="batchFilter" class="styled-select">
                    <option value="">All Batches</option>
                    <option value="online1">Online 1</option>
                    <option value="online2">Online 2</option>
                    <option value="offline_advance">Offline Advanced</option>
                    <option value="offline_base">Offline Base</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-money-bill-wave"></i> Fee Status</label>
                <select id="feesFilter" class="styled-select">
                    <option value="">All</option>
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                    <option value="expiring">Expiring Soon (‚â§7 days)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-user-circle"></i> Status</label>
                <select id="statusFilter" class="styled-select">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="disabled">Disabled</option>
                    <option value="new">New</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label><i class="fas fa-sort"></i> Sort By</label>
                <select id="sortFilter" class="styled-select">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="rating_high">Rating: High to Low</option>
                    <option value="rating_low">Rating: Low to High</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <div class="filter-info" id="filterInfo">
                Showing all students
            </div>
            <button class="btn-primary" onclick="loadStudents()">
                <i class="fas fa-check"></i> Apply Filters
            </button>
        </div>
    </div>

    <!-- Students Table -->
    <div class="table-card">
        <div class="table-header">
            <h3><i class="fas fa-list"></i> Students List</h3>
            <div class="table-actions">
                <div class="records-count">
                    <span id="recordsCount">0</span> students found
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Loading students...</p>
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <h3>No students found</h3>
                <p>Try adjusting your search or filters</p>
                <button class="btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-redo"></i> Clear All Filters
                </button>
            </div>
            
            <table class="students-table" id="studentsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Student Details</th>
                        <th>Contact</th>
                        <th>Rating</th>
                        <th>Fees</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="table-footer" id="tableFooter" style="display: none;">
            <div class="pagination-info">
                Showing <span id="startCount">1</span> to <span id="endCount">10</span> of 
                <span id="totalCount">0</span> students
            </div>
        </div>
    </div>
</div>

<!-- Fee History Modal -->
<div class="modal" id="feeHistoryModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2><i class="fas fa-history"></i> Fee Payment History</h2>
            <button class="close-modal" onclick="closeFeeHistoryModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="student-info-card">
                <div class="student-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div>
                    <h3 id="modalStudentName">-</h3>
                    <p><i class="fas fa-layer-group"></i> Batch: <span id="modalStudentBatch">-</span></p>
                </div>
            </div>
            
            <div id="feeHistoryContent" class="fee-history-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Update Batch Modal -->
<div class="modal" id="batchModal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2><i class="fas fa-exchange-alt"></i> Update Batch</h2>
            <button class="close-modal" onclick="closeBatchModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Student</label>
                <p id="batchModalStudentName" class="student-display-name">-</p>
            </div>
            <div class="form-group">
                <label><i class="fas fa-layer-group"></i> Select New Batch</label>
                <select id="batchSelect" class="styled-select">
                    <option value="online1">Online 1</option>
                    <option value="online2">Online 2</option>
                    <option value="offline_advance">Offline Advanced</option>
                    <option value="offline_base">Offline Base</option>
                </select>
            </div>
            <button class="btn-primary btn-block" onclick="updateBatch()">
                <i class="fas fa-save"></i> Update Batch
            </button>
        </div>
    </div>
</div>

<!-- Update Rating Modal -->
<div class="modal" id="ratingModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2><i class="fas fa-chart-line"></i> Update Student Rating</h2>
            <button class="close-modal" onclick="closeRatingModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Student</label>
                <p id="ratingModalStudentName" class="student-display-name">-</p>
            </div>
            
            <div class="current-rating-display">
                <div class="current-rating-label">Current Rating:</div>
                <div id="currentRatingDisplay" class="current-rating-value">0</div>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-star"></i> New Rating <span class="required">*</span></label>
                <div class="rating-input-container">
                    <input type="range" id="ratingSlider" min="0" max="3000" step="10" value="0">
                    <input type="number" id="newRating" 
                           min="0" max="3000" step="10" 
                           placeholder="Enter rating (0-3000)">
                </div>
                <div class="rating-scale-info">
                    <span class="scale-item beginner">Beginner: 0-999</span>
                    <span class="scale-item intermediate">Intermediate: 1000-1499</span>
                    <span class="scale-item advanced">Advanced: 1500+</span>
                </div>
            </div>
            
            <div class="rating-preview-card">
                <h4><i class="fas fa-eye"></i> Preview</h4>
                <div class="preview-content">
                    <div id="ratingPreview" class="rating-preview-badge rating-low">0</div>
                    <div class="preview-details">
                        <div id="ratingLevel" class="rating-level">Beginner</div>
                        <div id="ratingChange" class="rating-change">No change</div>
                    </div>
                </div>
            </div>
            
            <div class="quick-rating-section">
                <h4><i class="fas fa-bolt"></i> Quick Set</h4>
                <div class="quick-rating-buttons">
                    <button type="button" class="quick-rating-btn beginner" onclick="setQuickRating(600)">
                        600 (Beginner)
                    </button>
                    <button type="button" class="quick-rating-btn intermediate" onclick="setQuickRating(1200)">
                        1200 (Intermediate)
                    </button>
                    <button type="button" class="quick-rating-btn advanced" onclick="setQuickRating(1800)">
                        1800 (Advanced)
                    </button>
                    <button type="button" class="quick-rating-btn reset" onclick="setQuickRating(0)">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            
            <button class="btn-primary btn-block" onclick="updateRating()">
                <i class="fas fa-check-circle"></i> Update Rating
            </button>
        </div>
    </div>
</div>

<!-- Offline Payment Modal -->
<div class="modal" id="offlinePaymentModal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2><i class="fas fa-money-check-alt"></i> Add Offline Payment</h2>
            <button class="close-modal" onclick="closeOfflinePaymentModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Student</label>
                <p id="offlinePaymentStudentName" class="student-display-name">-</p>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-calendar-alt"></i> Payment Plan <span class="required">*</span></label>
                <div class="plan-options">
                    <div class="plan-option" data-plan="1month" onclick="selectPlan('1month')">
                        <div class="plan-header">
                            <h4>1 Month</h4>
                            <span class="plan-badge popular">Most Popular</span>
                        </div>
                        <div class="plan-price">‚Çπ3,000</div>
                        <div class="plan-desc">30 days access</div>
                    </div>
                    <div class="plan-option" data-plan="3months" onclick="selectPlan('3months')">
                        <div class="plan-header">
                            <h4>3 Months</h4>
                            <span class="plan-badge save">Save 17%</span>
                        </div>
                        <div class="plan-price">‚Çπ7,500</div>
                        <div class="plan-desc">90 days access</div>
                    </div>
                </div>
                <input type="hidden" id="offlinePlanSelect" value="1month">
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-credit-card"></i> Payment Method</label>
                <select id="offlinePaymentMethod" class="styled-select">
                    <option value="cash">üíµ Cash</option>
                    <option value="bank_transfer">üè¶ Bank Transfer</option>
                    <option value="cheque">üìÑ Cheque</option>
                    <option value="upi">üì± UPI (Offline)</option>
                    <option value="other">üìù Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-sticky-note"></i> Notes (Optional)</label>
                <textarea id="offlinePaymentNotes" 
                          placeholder="Add any additional notes like transaction ID, reference number, etc..."
                          rows="3"></textarea>
            </div>
            
            <div class="payment-notice">
                <div class="notice-header">
                    <i class="fas fa-info-circle"></i>
                    <span>Important Information</span>
                </div>
                <ul class="notice-list">
                    <li>Payment will be immediately verified</li>
                    <li>Student status will be set to <strong>ACTIVE</strong></li>
                    <li>If fees already paid, expiry extends from current date</li>
                    <li>If fees expired/unpaid, starts from today</li>
                </ul>
            </div>
            
            <button class="btn-success btn-block" onclick="submitOfflinePayment()">
                <i class="fas fa-check-double"></i> Add Payment & Verify
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="{{ url_for('static', filename='js/admin_students.js') }}"></script>
{% endblock %}